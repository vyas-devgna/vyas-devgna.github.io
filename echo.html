<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>P2P Mesh Chat</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- External Libraries (No Build Step) -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

    <style>
        /* UI Polish */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
        
        .scan-line {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 2px;
            background: rgba(99, 102, 241, 0.5);
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.8);
            animation: scan 2s linear infinite;
        }
        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        .video-wrapper video {
            transform: rotateY(180deg); /* Mirror effect */
        }
        
        /* Prevent iOS tap highlight */
        * { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 font-sans h-[100dvh] w-screen overflow-hidden selection:bg-indigo-500 selection:text-white">

    <!-- APP CONTAINER -->
    <div id="app" class="relative h-full w-full max-w-5xl mx-auto flex flex-col bg-slate-900 shadow-2xl sm:border-x sm:border-slate-800">

        <!-- HEADER -->
        <header class="flex-none bg-slate-900/90 backdrop-blur border-b border-slate-800 p-4 flex justify-between items-center z-50">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-indigo-600 flex items-center justify-center shadow-lg shadow-indigo-500/20">
                    <i class="fa-solid fa-network-wired text-white text-sm"></i>
                </div>
                <div>
                    <h1 class="text-sm font-bold tracking-tight text-white leading-none">P2P Mesh</h1>
                    <span class="text-[10px] text-slate-500 font-mono">PeerJS â€¢ Decentralized</span>
                </div>
            </div>
            <div id="status-badge" class="px-2 py-1 rounded-md bg-slate-800 border border-slate-700 text-[10px] font-mono text-slate-400 flex items-center gap-2">
                <div id="status-dot" class="w-1.5 h-1.5 rounded-full bg-slate-500"></div>
                <span id="status-text">Offline</span>
            </div>
        </header>

        <!-- SETUP VIEW -->
        <main id="view-setup" class="flex-1 flex flex-col items-center justify-center p-6 space-y-8 relative overflow-y-auto">
            <div class="absolute inset-0 overflow-hidden pointer-events-none opacity-20">
                <div class="absolute top-10 left-10 w-64 h-64 bg-indigo-600 rounded-full blur-[100px]"></div>
                <div class="absolute bottom-10 right-10 w-64 h-64 bg-violet-600 rounded-full blur-[100px]"></div>
            </div>

            <div class="text-center z-10 space-y-2">
                <h2 class="text-3xl font-black text-white tracking-tighter">Enter the Mesh</h2>
                <p class="text-slate-400 text-sm">Select a protocol to begin searching.</p>
            </div>

            <!-- Mode Selector -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 w-full max-w-2xl z-10">
                <!-- Text Mode -->
                <button onclick="logic.selectMode('text')" class="mode-btn group relative p-5 bg-slate-800/50 hover:bg-slate-800 border border-slate-700 hover:border-indigo-500 rounded-xl transition-all text-left">
                    <div class="flex justify-between items-start mb-2">
                        <i class="fa-solid fa-comment-dots text-2xl text-slate-500 group-hover:text-indigo-400 transition-colors"></i>
                        <div class="mode-check opacity-0 text-indigo-400 transition-opacity"><i class="fa-solid fa-circle-check"></i></div>
                    </div>
                    <h3 class="font-bold text-slate-200">Text Protocol</h3>
                    <p class="text-xs text-slate-500 mt-1">DataChannel only. No media.</p>
                </button>

                <!-- Audio Mode -->
                <button onclick="logic.selectMode('audio')" class="mode-btn group relative p-5 bg-slate-800/50 hover:bg-slate-800 border border-slate-700 hover:border-indigo-500 rounded-xl transition-all text-left">
                    <div class="flex justify-between items-start mb-2">
                        <i class="fa-solid fa-microphone-lines text-2xl text-slate-500 group-hover:text-indigo-400 transition-colors"></i>
                        <div class="mode-check opacity-0 text-indigo-400 transition-opacity"><i class="fa-solid fa-circle-check"></i></div>
                    </div>
                    <h3 class="font-bold text-slate-200">Audio Protocol</h3>
                    <p class="text-xs text-slate-500 mt-1">Voice + Text. Camera disabled.</p>
                </button>

                <!-- Video Mode -->
                <button onclick="logic.selectMode('video')" class="mode-btn group relative p-5 bg-slate-800/50 hover:bg-slate-800 border border-slate-700 hover:border-indigo-500 rounded-xl transition-all text-left">
                    <div class="flex justify-between items-start mb-2">
                        <i class="fa-solid fa-eye text-2xl text-slate-500 group-hover:text-indigo-400 transition-colors"></i>
                        <div class="mode-check opacity-0 text-indigo-400 transition-opacity"><i class="fa-solid fa-circle-check"></i></div>
                    </div>
                    <h3 class="font-bold text-slate-200">Video Protocol</h3>
                    <p class="text-xs text-slate-500 mt-1">Full Duplex. Mutual reveal.</p>
                </button>
            </div>

            <!-- Interests -->
            <div class="w-full max-w-md z-10">
                <div class="relative group">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fa-solid fa-hashtag text-slate-500 group-focus-within:text-indigo-500 text-xs"></i>
                    </div>
                    <input type="text" id="input-interests" placeholder="Interests (e.g., coding, music)..." 
                        class="w-full bg-slate-900 border border-slate-700 text-slate-200 text-sm rounded-lg block pl-8 p-3 focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 transition-all placeholder-slate-600">
                </div>
            </div>

            <button onclick="logic.start()" id="btn-start" disabled
                class="z-10 w-full max-w-xs bg-white text-slate-950 hover:bg-indigo-50 disabled:opacity-50 disabled:cursor-not-allowed font-bold py-3.5 rounded-full shadow-[0_0_20px_rgba(255,255,255,0.1)] transition-all transform active:scale-95 flex items-center justify-center gap-2">
                <span>Initialise Uplink</span>
                <i class="fa-solid fa-bolt"></i>
            </button>
        </main>

        <!-- SEARCH VIEW -->
        <main id="view-search" class="hidden flex-1 flex flex-col items-center justify-center p-6 relative">
            <div class="scan-line z-0"></div>
            
            <div class="relative z-10 text-center space-y-6">
                <div class="relative inline-block">
                    <div class="absolute inset-0 bg-indigo-500 rounded-full blur opacity-20 animate-pulse"></div>
                    <i class="fa-solid fa-radar text-5xl text-indigo-400 animate-spin-slow" style="animation-duration: 3s;"></i>
                </div>
                
                <div>
                    <h2 class="text-2xl font-bold text-white">Scanning Network</h2>
                    <p id="search-log" class="text-indigo-300 font-mono text-xs mt-2 h-4">Connecting to discovery node...</p>
                </div>

                <div class="text-[10px] text-slate-500 font-mono border border-slate-800 p-2 rounded bg-slate-900/50 max-w-[200px] mx-auto truncate">
                    ID: <span id="my-id-display">Generating...</span>
                </div>

                <button onclick="logic.stop(true)" class="px-6 py-2 border border-slate-600 text-slate-400 rounded-full hover:bg-slate-800 hover:text-white transition-colors text-sm">
                    Abort
                </button>
            </div>
        </main>

        <!-- CHAT VIEW -->
        <main id="view-chat" class="hidden flex-1 flex flex-col relative bg-black">
            <!-- Video Layer -->
            <div id="video-container" class="absolute inset-0 flex items-center justify-center bg-slate-900 hidden">
                <div class="text-slate-700 flex flex-col items-center gap-2">
                    <i class="fa-solid fa-ghost text-4xl"></i>
                    <span class="text-xs uppercase tracking-widest">No Signal</span>
                </div>
                <!-- Remote -->
                <video id="remote-video" autoplay playsinline class="absolute inset-0 w-full h-full object-cover z-10 bg-black"></video>
                <!-- Local -->
                <div class="absolute bottom-4 right-4 w-[120px] sm:w-[200px] aspect-[3/4] sm:aspect-video bg-slate-800 rounded-lg overflow-hidden border border-slate-700 shadow-2xl z-20 video-wrapper">
                    <video id="local-video" autoplay playsinline muted class="w-full h-full object-cover"></video>
                </div>
                <!-- Controls -->
                <div class="absolute bottom-4 left-4 z-30 flex gap-2">
                    <button id="btn-mic" onclick="logic.toggleAudio()" class="w-10 h-10 rounded-full bg-black/50 backdrop-blur text-white hover:bg-slate-800 border border-white/10 flex items-center justify-center"><i class="fa-solid fa-microphone"></i></button>
                    <button id="btn-cam" onclick="logic.toggleVideo()" class="w-10 h-10 rounded-full bg-black/50 backdrop-blur text-white hover:bg-slate-800 border border-white/10 flex items-center justify-center"><i class="fa-solid fa-video"></i></button>
                </div>
            </div>

            <!-- Chat Layer (Overlaid or Full) -->
            <div id="chat-layer" class="relative z-30 flex-1 flex flex-col h-full bg-slate-900 transition-all duration-500">
                <!-- Messages -->
                <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-3 mask-image-b">
                    <!-- Dynamic -->
                </div>
                
                <!-- Input -->
                <div class="p-3 bg-slate-900/90 backdrop-blur border-t border-slate-800 safe-pb">
                    <form onsubmit="logic.sendMsg(event)" class="flex gap-2">
                        <input id="msg-input" type="text" autocomplete="off" placeholder="Message..." class="flex-1 bg-slate-800 text-white rounded-full px-4 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500 border border-slate-700">
                        <button type="submit" class="w-9 h-9 bg-indigo-600 rounded-full text-white flex items-center justify-center hover:bg-indigo-500 transition-colors"><i class="fa-solid fa-paper-plane text-xs"></i></button>
                    </form>
                </div>
            </div>

            <!-- Global Footer Controls -->
            <div class="absolute top-4 right-4 z-40 flex gap-2">
                <button onclick="logic.skip()" class="bg-white text-slate-900 px-4 py-1.5 rounded-full text-xs font-bold shadow-lg hover:bg-slate-200 transition-colors flex items-center gap-1">
                    SKIP <i class="fa-solid fa-forward"></i>
                </button>
                <button onclick="logic.stop(true)" class="bg-red-500/80 backdrop-blur text-white w-8 h-8 rounded-full flex items-center justify-center hover:bg-red-600 transition-colors">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
        </main>
    </div>

    <!-- LOGIC -->
    <script>
        /**
         * CORE ARCHITECTURE:
         * 1. PeerJS: Handles WebRTC Transport (SDP/ICE/Encryption).
         * 2. MQTT (Public Broker): Handles Service Discovery (The "Lobby").
         * 3. Deterministic Matching: lexical comparison of PeerIDs avoids collision.
         */
        
        // --- CONSTANTS ---
        const MQTT_BROKER = 'wss://broker.emqx.io:8084/mqtt'; // Reliable public broker over WSS
        const APP_TOPIC = 'omni-peer-v2'; // Namespace to avoid collision
        const PEER_CONFIG = {
            debug: 0,
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:global.stun.twilio.com:3478' }
                ]
            }
        };

        // --- STATE ---
        const state = {
            mode: null,
            interests: [],
            peer: null,        // PeerJS Instance
            mqtt: null,        // MQTT Client
            myId: null,
            conn: null,        // Active Data Connection
            call: null,        // Active Media Call
            localStream: null,
            status: 'idle',    // idle, searching, connected
            knownPeers: new Map(), // Discovery cache
            searchInterval: null,
            announceInterval: null,
            startTime: 0
        };

        // --- UI UTILS ---
        const ui = {
            views: {
                setup: document.getElementById('view-setup'),
                search: document.getElementById('view-search'),
                chat: document.getElementById('view-chat')
            },
            elements: {
                messages: document.getElementById('messages'),
                localVideo: document.getElementById('local-video'),
                remoteVideo: document.getElementById('remote-video'),
                videoContainer: document.getElementById('video-container'),
                chatLayer: document.getElementById('chat-layer'),
                statusText: document.getElementById('status-text'),
                statusDot: document.getElementById('status-dot'),
                searchLog: document.getElementById('search-log'),
                myIdDisplay: document.getElementById('my-id-display')
            },

            show(viewId) {
                Object.values(this.views).forEach(v => v.classList.add('hidden'));
                this.views[viewId].classList.remove('hidden');
                
                // Mode UI Adaptations
                if (viewId === 'chat') {
                    if (state.mode === 'text') {
                        this.elements.videoContainer.classList.add('hidden');
                        this.elements.chatLayer.classList.remove('absolute', 'w-[300px]', 'h-[400px]', 'bottom-20', 'left-4', 'rounded-xl', 'border', 'border-slate-700', 'shadow-2xl');
                        this.elements.chatLayer.classList.add('h-full', 'w-full');
                        this.elements.chatLayer.style.backgroundColor = ''; // Reset
                    } else {
                        this.elements.videoContainer.classList.remove('hidden');
                        // Make chat overlay on mobile, side panel on desktop usually, but for single file simple overlay
                        this.elements.chatLayer.className = 'absolute bottom-20 left-4 w-[calc(100%-2rem)] sm:w-80 h-64 bg-slate-900/80 backdrop-blur-md rounded-xl border border-white/10 shadow-2xl z-30 flex flex-col transition-all';
                    }
                }
            },

            log(msg, type = 'system') {
                const div = document.createElement('div');
                if (type === 'system') {
                    div.className = 'text-[10px] text-center text-slate-500 font-mono py-1';
                    div.innerHTML = `<span class="bg-slate-800 px-2 py-0.5 rounded">${msg}</span>`;
                } else if (type === 'me') {
                    div.className = 'self-end bg-indigo-600 text-white px-4 py-2 rounded-2xl rounded-tr-sm max-w-[85%] text-sm shadow-md break-words';
                    div.textContent = msg;
                } else {
                    div.className = 'self-start bg-slate-800 text-slate-200 px-4 py-2 rounded-2xl rounded-tl-sm max-w-[85%] text-sm shadow-md border border-slate-700 break-words';
                    div.textContent = msg;
                }
                this.elements.messages.appendChild(div);
                this.elements.messages.scrollTop = this.elements.messages.scrollHeight;
            },

            setStatus(msg, color) {
                this.elements.statusText.textContent = msg;
                this.elements.statusDot.className = `w-1.5 h-1.5 rounded-full ${color}`;
            }
        };

        // --- CORE LOGIC ---
        const logic = {
            init() {
                ui.setStatus('Ready', 'bg-green-500');
            },

            selectMode(m) {
                state.mode = m;
                document.querySelectorAll('.mode-btn').forEach(b => {
                    b.classList.remove('ring-2', 'ring-indigo-500', 'bg-slate-800');
                    b.querySelector('.mode-check').classList.add('opacity-0');
                });
                const active = document.querySelector(`button[onclick="logic.selectMode('${m}')"]`);
                active.classList.add('ring-2', 'ring-indigo-500', 'bg-slate-800');
                active.querySelector('.mode-check').classList.remove('opacity-0');
                document.getElementById('btn-start').disabled = false;
            },

            async start() {
                const interestStr = document.getElementById('input-interests').value;
                state.interests = interestStr ? interestStr.split(',').map(s => s.trim().toLowerCase()).filter(s => s) : [];
                
                // 1. Get Media (if needed)
                if (state.mode !== 'text') {
                    try {
                        state.localStream = await navigator.mediaDevices.getUserMedia({
                            audio: true,
                            video: state.mode === 'video' ? { facingMode: 'user' } : false
                        });
                        ui.elements.localVideo.srcObject = state.localStream;
                    } catch (e) {
                        alert('Permission denied. Cannot start ' + state.mode + ' mode.');
                        return;
                    }
                }

                ui.show('search');
                this.connectToPeerJS();
            },

            // --- PEERJS SETUP ---
            connectToPeerJS() {
                ui.elements.searchLog.textContent = "Initializing PeerJS...";
                // Create a random ID ourselves or let PeerJS do it. 
                // We'll let PeerJS do it to ensure uniqueness in their cloud.
                state.peer = new Peer(null, PEER_CONFIG);

                state.peer.on('open', (id) => {
                    state.myId = id;
                    ui.elements.myIdDisplay.textContent = id;
                    ui.elements.searchLog.textContent = "Connected to Signal. Connecting to Queue...";
                    this.connectToMQTT(); // Once we have an ID, join the queue
                });

                state.peer.on('connection', (conn) => {
                    // Incoming Data Connection
                    if (state.status === 'searching' || state.status === 'connected') {
                        this.handleConnection(conn);
                    } else {
                        conn.close(); // Not ready
                    }
                });

                state.peer.on('call', (call) => {
                    // Incoming Media Call
                    if (state.status === 'searching' || state.status === 'connected') {
                        call.answer(state.localStream);
                        this.handleCall(call);
                    } else {
                        call.close();
                    }
                });

                state.peer.on('error', (err) => {
                    console.error("PeerJS Error", err);
                    if (err.type === 'peer-unavailable') {
                        this.resumeSearch("Peer vanished.");
                    }
                });
            },

            // --- MQTT DISCOVERY SETUP ---
            connectToMQTT() {
                // Client ID must be random to avoid disconnects
                const clientId = 'web_' + Math.random().toString(16).substring(2, 8);
                state.mqtt = mqtt.connect(MQTT_BROKER, {
                    clientId: clientId,
                    clean: true,
                    keepalive: 30
                });

                state.mqtt.on('connect', () => {
                    ui.elements.searchLog.textContent = "Joined Discovery Network.";
                    const topic = `${APP_TOPIC}/${state.mode}`;
                    state.mqtt.subscribe(topic);
                    
                    this.beginMatchmaking();
                });

                state.mqtt.on('message', (topic, message) => {
                    if (state.status !== 'searching') return;
                    try {
                        const payload = JSON.parse(message.toString());
                        // Ignore self
                        if (payload.id === state.myId) return;
                        
                        // Add to known peers cache
                        state.knownPeers.set(payload.id, {
                            ...payload,
                            lastSeen: Date.now()
                        });
                    } catch(e) {}
                });
            },

            // --- MATCHMAKING LOOP ---
            beginMatchmaking() {
                state.status = 'searching';
                state.startTime = Date.now();
                state.knownPeers.clear();

                // 1. Announce Loop (Heartbeat)
                // Publish my presence every 1.5s
                state.announceInterval = setInterval(() => {
                    if (state.status !== 'searching' || !state.mqtt || !state.mqtt.connected) return;
                    const payload = JSON.stringify({
                        id: state.myId,
                        interests: state.interests,
                        ts: Date.now()
                    });
                    state.mqtt.publish(`${APP_TOPIC}/${state.mode}`, payload);
                }, 1500);

                // 2. Scan Loop (Matchmaker)
                // Check cached peers every 1s
                state.searchInterval = setInterval(() => {
                    if (state.status !== 'searching') return;
                    
                    const now = Date.now();
                    let bestCandidate = null;
                    let maxScore = -1;

                    // Filter and Score Peers
                    for (const [id, data] of state.knownPeers) {
                        // Remove ghosts (> 5s old)
                        if (now - data.lastSeen > 5000) {
                            state.knownPeers.delete(id);
                            continue;
                        }

                        // Score logic
                        let score = 0;
                        
                        // Interest Match
                        const common = data.interests.filter(i => state.interests.includes(i)).length;
                        if (common > 0) score += 10 + common;
                        
                        // Expand search over time (relax constraints)
                        const waitingTime = (now - state.startTime) / 1000;
                        
                        // Strict mode initially? No, let's just prioritize.
                        // But if interests are set, prioritize them.
                        if (state.interests.length > 0 && common === 0 && waitingTime < 10) {
                            continue; // Wait 10s for an interest match before accepting random
                        }

                        // FIFO Logic (approximate based on ID string to be deterministic)
                        // Actually, we use ID comparison for the "Who calls who" rule.
                        
                        if (score > maxScore) {
                            maxScore = score;
                            bestCandidate = id;
                        }
                    }

                    if (bestCandidate) {
                        this.attemptMatch(bestCandidate);
                    }
                }, 1000);
            },

            attemptMatch(peerId) {
                // DETERMINISTIC RULE:
                // Compare strings. If MyID > PeerID, I call. If MyID < PeerID, I wait.
                // This prevents both peers attempting to call simultaneously and failing to connect.
                
                if (state.myId > peerId) {
                    ui.elements.searchLog.textContent = `Connecting to ${peerId.substr(0,4)}...`;
                    state.status = 'connecting'; // Stop loop
                    this.initiateCall(peerId);
                } else {
                    // I do nothing. I wait for them to call me.
                    // But I update status visually so user knows we found someone
                    ui.elements.searchLog.textContent = `Waiting for ${peerId.substr(0,4)} to connect...`;
                }
            },

            initiateCall(remoteId) {
                // 1. Data Connection (Always)
                const conn = state.peer.connect(remoteId, { reliable: true });
                this.handleConnection(conn);

                // 2. Media Call (If audio/video)
                if (state.mode !== 'text' && state.localStream) {
                    const call = state.peer.call(remoteId, state.localStream);
                    this.handleCall(call);
                }
            },

            // --- CONNECTION HANDLERS ---
            handleConnection(conn) {
                state.conn = conn;

                conn.on('open', () => {
                    // Match Confirmed
                    this.finalizeConnection();
                    ui.log("Peer connected via DataChannel.", "system");
                });

                conn.on('data', (data) => {
                    if (typeof data === 'string') {
                        ui.log(data, 'remote');
                    }
                });

                conn.on('close', () => {
                    this.resumeSearch("Peer disconnected.");
                });
                
                conn.on('error', () => {
                    this.resumeSearch("Connection error.");
                });
            },

            handleCall(call) {
                state.call = call;

                call.on('stream', (remoteStream) => {
                    ui.elements.remoteVideo.srcObject = remoteStream;
                });

                call.on('close', () => {
                   // Usually handled by DataChannel close, but just in case
                });
            },

            finalizeConnection() {
                // Stop MQTT announcements
                state.status = 'connected';
                if (state.announceInterval) clearInterval(state.announceInterval);
                if (state.searchInterval) clearInterval(state.searchInterval);
                
                // Unsubscribe to save bandwidth (optional, but good practice)
                if(state.mqtt) state.mqtt.unsubscribe(`${APP_TOPIC}/${state.mode}`);

                ui.show('chat');
                ui.elements.messages.innerHTML = ''; // Clear old chat
                ui.log(`Connected! Mode: ${state.mode.toUpperCase()}`, 'system');
                ui.setStatus('Online', 'bg-green-500');
            },

            // --- ACTIONS ---
            sendMsg(e) {
                e.preventDefault();
                const input = document.getElementById('msg-input');
                const val = input.value.trim();
                if (!val) return;

                if (state.conn && state.conn.open) {
                    state.conn.send(val);
                    ui.log(val, 'me');
                    input.value = '';
                } else {
                    ui.log('Connection lost.', 'system');
                }
            },

            toggleAudio() {
                if (!state.localStream) return;
                const track = state.localStream.getAudioTracks()[0];
                track.enabled = !track.enabled;
                document.getElementById('btn-mic').innerHTML = track.enabled ? '<i class="fa-solid fa-microphone"></i>' : '<i class="fa-solid fa-microphone-slash"></i>';
                document.getElementById('btn-mic').classList.toggle('bg-red-500', !track.enabled);
            },

            toggleVideo() {
                if (!state.localStream) return;
                const track = state.localStream.getVideoTracks()[0];
                track.enabled = !track.enabled;
                document.getElementById('btn-cam').innerHTML = track.enabled ? '<i class="fa-solid fa-video"></i>' : '<i class="fa-solid fa-video-slash"></i>';
                document.getElementById('btn-cam').classList.toggle('bg-red-500', !track.enabled);
            },

            skip() {
                if (state.conn) state.conn.close();
                if (state.call) state.call.close();
                this.resumeSearch("Skipping...");
            },

            resumeSearch(reason) {
                if (state.status === 'searching') return; // Already searching

                // Cleanup connections but keep Peer and MQTT alive
                state.conn = null;
                state.call = null;
                ui.elements.remoteVideo.srcObject = null;
                
                ui.show('search');
                ui.elements.searchLog.textContent = reason || "Searching...";
                
                // Resubscribe MQTT
                if(state.mqtt && state.mqtt.connected) {
                    state.mqtt.subscribe(`${APP_TOPIC}/${state.mode}`);
                }
                
                this.beginMatchmaking();
            },

            stop(fullReset = false) {
                if (state.announceInterval) clearInterval(state.announceInterval);
                if (state.searchInterval) clearInterval(state.searchInterval);
                
                if (state.conn) state.conn.close();
                if (state.call) state.call.close();
                if (state.localStream) {
                    state.localStream.getTracks().forEach(t => t.stop());
                    state.localStream = null;
                }
                
                state.status = 'idle';
                
                if (fullReset) {
                    // Destroy Peer/MQTT for clean restart
                    if (state.peer) state.peer.destroy();
                    if (state.mqtt) state.mqtt.end();
                    state.peer = null;
                    state.mqtt = null;
                    ui.show('setup');
                    ui.setStatus('Offline', 'bg-slate-500');
                }
            }
        };

        // Init
        logic.init();

    </script>
</body>
</html>

