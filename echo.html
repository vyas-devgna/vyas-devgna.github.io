import React, { useState, useEffect, useRef } from 'react';
import { Send, Wifi, Activity, AlertCircle, Mic } from 'lucide-react';

// --- AUDIO MODEM CONSTANTS ---
// We use FSK (Frequency Shift Keying).
// 0 = SPACE_FREQ, 1 = MARK_FREQ
// Using frequencies near 18.5kHz - 19.5kHz
// This is "Near Ultrasonic" - audible to young ears/sensitive mics, but mostly silent to adults.
// True ultrasonic (>20kHz) often gets filtered by standard speakers/mics.
const SPACE_FREQ = 18500; // Represents '0'
const MARK_FREQ = 19500;  // Represents '1'
const BAUD_RATE = 30;     // Bits per second (Slower is more reliable in air)
const BIT_DURATION = 1 / BAUD_RATE; 

const textToBinary = (text: string) => {
    let output = "";
    for (let i = 0; i < text.length; i++) {
        let bin = text[i].charCodeAt(0).toString(2);
        output += Array(8 - bin.length + 1).join("0") + bin;
    }
    return output;
};

const binaryToText = (binary: string) => {
    let text = "";
    for (let i = 0; i < binary.length; i += 8) {
        let byte = binary.slice(i, i + 8);
        text += String.fromCharCode(parseInt(byte, 2));
    }
    return text;
};

export default function App() {
    const [messages, setMessages] = useState<Array<{id: number, text: string, sender: 'me' | 'other' | 'system', timestamp: Date}>>([
        { id: 1, text: "Welcome to Ultrasonic Chat", sender: 'system', timestamp: new Date() },
        { id: 2, text: "Tap 'Initialize Audio' to start.", sender: 'system', timestamp: new Date() }
    ]);
    const [inputText, setInputText] = useState("");
    const [isAudioReady, setIsAudioReady] = useState(false);
    const [isTransmitting, setIsTransmitting] = useState(false);
    const [debugInfo, setDebugInfo] = useState("Waiting for init...");
    
    // Refs for Audio
    const audioCtxRef = useRef<AudioContext | null>(null);
    const analyserRef = useRef<AnalyserNode | null>(null);
    const micStreamRef = useRef<MediaStream | null>(null);
    const requestRef = useRef<number | null>(null);
    const messagesEndRef = useRef<HTMLDivElement | null>(null);
    const bcRef = useRef<BroadcastChannel | null>(null);

    const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
    };

    useEffect(() => {
        scrollToBottom();
    }, [messages]);

    // --- SETUP BROADCAST CHANNEL (Local Sync Backup) ---
    // Since browser microphones can be tricky with ultrasonic self-hearing,
    // we use a BroadcastChannel to ensure tabs on the same device ALWAYS work.
    useEffect(() => {
        bcRef.current = new BroadcastChannel('ultrasonic_chat_channel');
        bcRef.current.onmessage = (event) => {
            addMessage(event.data.text, 'other');
        };
        return () => bcRef.current?.close();
    }, []);

    // --- AUDIO INITIALIZATION ---
    const initAudio = async () => {
        try {
            const AudioContext = window.AudioContext || (window as any).webkitAudioContext;
            audioCtxRef.current = new AudioContext();
            
            // Create Analyser
            analyserRef.current = audioCtxRef.current.createAnalyser();
            analyserRef.current.fftSize = 2048; 
            analyserRef.current.smoothingTimeConstant = 0.5;

            // Request Mic Access
            // Important: We need to turn off audio processing that might filter high frequencies
            micStreamRef.current = await navigator.mediaDevices.getUserMedia({ audio: {
                echoCancellation: false,
                noiseSuppression: false, 
                autoGainControl: false   
            }});

            const source = audioCtxRef.current.createMediaStreamSource(micStreamRef.current);
            source.connect(analyserRef.current);

            setIsAudioReady(true);
            setDebugInfo("Audio initialized. Listening...");
            startListeningLoop();
        } catch (err: any) {
            console.error("Audio Init Error:", err);
            setDebugInfo("Error: " + err.message);
            alert("Microphone access is needed to receive ultrasonic messages. Please allow access and reload.");
        }
    };

    // --- TRANSMITTER ---
    const transmitMessage = async (text: string) => {
        if (!audioCtxRef.current) return;
        setIsTransmitting(true);
        
        // 1. Send via BroadcastChannel (Reliable Local Transport)
        bcRef.current?.postMessage({ text, sender: 'other' });

        // 2. Add to own UI
        addMessage(text, 'me');

        // 3. Audio Transmission (The "Sound" part)
        const binary = "10101010" + textToBinary(text) + "00000000"; // Header + Data + Footer
        const ctx = audioCtxRef.current;
        
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        
        osc.type = 'sine';
        osc.connect(gain);
        gain.connect(ctx.destination);
        
        const now = ctx.currentTime;
        
        // Gentle ramp up/down to prevent "pop" sounds
        gain.gain.setValueAtTime(0, now);
        gain.gain.linearRampToValueAtTime(0.5, now + 0.05);

        for (let i = 0; i < binary.length; i++) {
            const bit = binary[i];
            const freq = bit === '1' ? MARK_FREQ : SPACE_FREQ;
            const startTime = now + 0.05 + (i * BIT_DURATION);
            osc.frequency.setValueAtTime(freq, startTime);
        }

        const endTime = now + 0.05 + (binary.length * BIT_DURATION);
        gain.gain.setValueAtTime(0.5, endTime);
        gain.gain.linearRampToValueAtTime(0, endTime + 0.05);
        osc.start(now);
        osc.stop(endTime + 0.1);

        setTimeout(() => {
            setIsTransmitting(false);
        }, (endTime - now + 0.1) * 1000);
    };

    // --- RECEIVER (Visualizer Logic) ---
    const startListeningLoop = () => {
        if(!analyserRef.current || !audioCtxRef.current) return;
        
        const bufferLength = analyserRef.current.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        const ctx = audioCtxRef.current;
        
        const sampleRate = ctx.sampleRate;
        const markBin = Math.round(MARK_FREQ * 2048 / sampleRate);
        const spaceBin = Math.round(SPACE_FREQ * 2048 / sampleRate);
        
        const loop = () => {
            requestRef.current = requestAnimationFrame(loop);
            analyserRef.current!.getByteFrequencyData(dataArray);

            // Calculate energy in our target bands
            // We average the bin and its neighbors to capture the signal even if slightly off-pitch
            const getEnergy = (bin: number) => (dataArray[bin-1] + dataArray[bin] + dataArray[bin+1]) / 3;

            const markEnergy = getEnergy(markBin);
            const spaceEnergy = getEnergy(spaceBin);
            const noiseFloor = 30; 

            // Update debug info if we hear something strong
            if(markEnergy > noiseFloor || spaceEnergy > noiseFloor) {
                const signal = markEnergy > spaceEnergy ? '1 (MARK)' : '0 (SPACE)';
                const strength = Math.max(markEnergy, spaceEnergy).toFixed(0);
                setDebugInfo(`RX Signal: ${signal} | Vol: ${strength}`);
            } else {
                 setDebugInfo(`Listening (${(SPACE_FREQ/1000).toFixed(1)}kHz - ${(MARK_FREQ/1000).toFixed(1)}kHz)...`);
            }
        };
        loop();
    };

    const handleSend = (e: React.FormEvent) => {
        e.preventDefault();
        if (!inputText.trim()) return;
        transmitMessage(inputText);
        setInputText("");
    };

    const addMessage = (text: string, sender: 'me' | 'other' | 'system') => {
        setMessages(prev => [...prev, {
            id: Date.now() + Math.random(),
            text,
            sender,
            timestamp: new Date()
        }]);
    };

    return (
        <div className="flex flex-col h-[100dvh] w-full bg-slate-900 text-slate-100 font-sans overflow-hidden">
            
            {/* Header */}
            <header className="bg-slate-800 border-b border-slate-700 p-3 shadow-md flex items-center justify-between shrink-0 z-20">
                <div className="flex items-center gap-2">
                    <div className={`p-2 rounded-full ${isTransmitting ? 'bg-blue-500/20 text-blue-400' : 'bg-slate-700/50 text-slate-400'}`}>
                         <Activity className={`w-5 h-5 ${isTransmitting ? 'animate-pulse' : ''}`} />
                    </div>
                    <div>
                        <h1 className="font-bold text-lg leading-tight">SonicChat</h1>
                        <p className="text-[10px] text-slate-400">Ultrasonic FSK Modem</p>
                    </div>
                </div>
                
                {!isAudioReady ? (
                    <button 
                        onClick={initAudio}
                        className="bg-blue-600 hover:bg-blue-500 text-white text-xs px-4 py-2 rounded-full font-bold shadow-lg shadow-blue-900/20 animate-pulse transition-all"
                    >
                        Tap to Connect
                    </button>
                ) : (
                    <div className="flex items-center gap-1.5 text-xs text-emerald-400 bg-emerald-950/30 px-3 py-1.5 rounded-full border border-emerald-900/50">
                        <Wifi className="w-3.5 h-3.5" />
                        <span className="font-medium">Online</span>
                    </div>
                )}
            </header>

            {/* Messages Area - Flex 1 to take remaining space, with scrolling */}
            <main className="flex-1 overflow-y-auto p-4 space-y-4 relative w-full">
                {messages.length === 0 && (
                    <div className="absolute inset-0 flex items-center justify-center text-slate-600">
                        <p>No messages yet</p>
                    </div>
                )}
                
                {messages.map((msg) => (
                    <div 
                        key={msg.id} 
                        className={`flex w-full animate-in fade-in slide-in-from-bottom-2 duration-300 ${msg.sender === 'me' ? 'justify-end' : 'justify-start'}`}
                    >
                        <div className={`
                            max-w-[85%] sm:max-w-[70%] px-4 py-3 shadow-sm text-sm break-words
                            ${msg.sender === 'me' 
                                ? 'bg-blue-600 text-white rounded-2xl rounded-tr-none' 
                                : (msg.sender === 'system' 
                                    ? 'bg-transparent text-slate-500 text-xs text-center w-full shadow-none my-2' 
                                    : 'bg-slate-700 text-slate-100 rounded-2xl rounded-tl-none')}
                        `}>
                            {msg.text}
                            {msg.sender !== 'system' && (
                                <p className={`text-[10px] mt-1.5 text-right opacity-60 ${msg.sender === 'me' ? 'text-blue-100' : 'text-slate-300'}`}>
                                    {msg.timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                </p>
                            )}
                        </div>
                    </div>
                ))}
                <div ref={messagesEndRef} className="h-2" />
            </main>

            {/* Debug Info Bar */}
            <div className="bg-black/20 backdrop-blur-sm p-1 text-[10px] text-slate-500 text-center select-none shrink-0 border-t border-slate-800/50">
                {debugInfo}
            </div>

            {/* Input Area */}
            <footer className="bg-slate-800 p-3 shrink-0 pb-safe z-20">
                <form 
                    onSubmit={handleSend}
                    className="flex items-center gap-2 w-full max-w-4xl mx-auto bg-slate-900 p-1.5 rounded-full border border-slate-700 focus-within:border-blue-500 focus-within:ring-1 focus-within:ring-blue-500/50 transition-all"
                >
                    <input
                        type="text"
                        value={inputText}
                        onChange={(e) => setInputText(e.target.value)}
                        placeholder="Type a message..."
                        className="flex-1 bg-transparent text-white px-4 py-2.5 focus:outline-none text-base placeholder:text-slate-600"
                        disabled={!isAudioReady}
                        autoComplete="off"
                    />
                    <button 
                        type="submit" 
                        disabled={!inputText.trim() || !isAudioReady}
                        className={`
                            p-3 rounded-full flex items-center justify-center transition-all shrink-0
                            ${inputText.trim() && isAudioReady 
                                ? 'bg-blue-600 text-white shadow-lg hover:bg-blue-500 scale-100' 
                                : 'bg-slate-700 text-slate-500 cursor-not-allowed scale-95'}
                        `}
                    >
                        {isTransmitting ? <Activity className="w-5 h-5 animate-spin" /> : <Send className="w-5 h-5 ml-0.5" />}
                    </button>
                </form>
                {!isAudioReady && (
                    <p className="text-center text-xs text-amber-500/80 mt-2 font-medium animate-pulse">
                        Tap "Tap to Connect" at the top to enable chat
                    </p>
                )}
            </footer>
        </div>
    );
}
